name: PR Fast Check

# Fast feedback for pull requests - runs analyze and tests only
# Full build matrix runs in main.yml workflow on merge to main/develop
on:
  pull_request:
    branches: [ main, develop ]

jobs:
  # Fast Check: Static Analysis and Tests Only
  fast_check:
    name: âš¡ Fast Check (Analyze & Test)
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository code
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # Step 2: Setup Flutter environment with caching
      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.6'
          channel: 'stable'
          cache: true

      # Step 3: Quick Flutter version check
      - name: ğŸ” Verify Flutter Installation
        run: flutter --version

      # Step 4: Get Flutter dependencies
      - name: ğŸ“¦ Get Dependencies
        run: flutter pub get

      # Step 5: Generate Mock Firebase Configs (for CI)
      - name: ğŸ”§ Generate Mock Firebase Configs
        run: dart run tools/generate_mock_firebase_configs.dart

      # Step 6: Verify that dependencies resolved properly
      - name: ğŸ” Verify Dependencies
        run: flutter pub deps

      # Step 7: Run static code analysis (initially warn-only to establish baseline)
      - name: ğŸ“Š Run Static Analysis
        run: |
          echo "Running Flutter analyze..."
          flutter analyze > analysis_results.txt 2>&1 || true
          echo "Analysis completed. Results:"
          cat analysis_results.txt
          # For now, we'll warn but not fail on analysis issues to establish CI/CD baseline
          # TODO: In future iterations, enable --fatal-warnings when code quality improves
          echo "âœ… Static analysis completed (warnings-only mode for CI/CD baseline)"

      # Step 8: Check code formatting (report only for now)
      - name: ğŸ¨ Check Code Formatting
        run: |
          echo "Checking code formatting..."
          dart format --set-exit-if-changed . || {
            echo "âš ï¸ Code formatting issues found"
            echo "Run 'dart format .' to fix formatting"
            echo "For now, this is informational only"
          }

      # Step 9: Run unit and widget tests (exclude integration tests)
      - name: ğŸ§ª Run Tests
        run: flutter test --coverage --reporter=github --exclude-tags=integration test/unit/ test/widget/

      # Step 10: Upload coverage reports (optional but recommended)
      - name: ğŸ“ˆ Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        if: success()
        with:
          file: coverage/lcov.info
          flags: flutter
          name: PlayWithMe Coverage
          fail_ci_if_error: false

      # Step 11: Build dev flavor to verify compilation
      - name: ğŸ”¨ Verify Compilation (Web Dev)
        run: flutter build web -t lib/main_dev.dart --release

  # Final Status
  fast_check_success:
    name: âœ… Fast Check Complete
    runs-on: ubuntu-latest
    needs: [fast_check]
    if: always()

    steps:
      - name: ğŸ‰ Fast Check Passed
        if: needs.fast_check.result == 'success'
        run: |
          echo "ğŸ‰ Fast check passed successfully!"
          echo "âœ… Static Analysis: Passed"
          echo "âœ… Tests: Passed"
          echo "âœ… Compilation: Verified"
          echo ""
          echo "âš¡ PR is ready for review!"

      - name: âŒ Fast Check Failed
        if: needs.fast_check.result != 'success'
        run: |
          echo "âŒ Fast check failed!"
          echo "ğŸ“Š Fast Check: ${{ needs.fast_check.result }}"
          echo ""
          echo "ğŸ›‘ Please fix the failing checks."
          exit 1
